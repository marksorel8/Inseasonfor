---
title: "Inseason Bonneville Dam Chinook salmon passage predictions"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
library(Inseasonfor)


forecastdate <- lubridate::today()-1
forecast_season<-chk_season(forecastdate)
forecast_year<-lubridate::year(forecastdate)
forecast_month<-lubridate::month(forecastdate)
forecast_md<-lubridate::mday(forecastdate)

#summer chinook forecast = 38,000, log_sd~ 0.33
#spring chinook forecast = 122500, log_sd~ 0.3

```

```{r data}
#fish data
Bon_cnts<-bon_dat_fun(pred_date=NULL,
                      count_file="fish_counts.csv",
                      url = "https://www.fpc.org/adults/R_coeadultcount_runsum")


bon_yr_seas<-Bon_cnts |> dplyr::filter(season==forecast_season,year==forecast_year)


if(nrow(bon_yr_seas)==0){
  errorCondition("There are no counts for the season of interest")
}

#max date
counts_through<- bon_yr_seas |>  dplyr::pull(CountDate) |>  max()

if(counts_through<forecastdate){
  forecastdate<-counts_through
  warning("counts are not available through the provided forecast date. Returning results based on the most updated counts available.")
}

# flow temp data
flow_temp_dat<-get_flow_data(forecastdate = forecastdate,flow_file = "flow_temp_dat.csv") 


#ocean cov data
ocean_cov<-ocean_cov_fun(forecast_year) |> 
  dplyr::mutate(Year=Year+2) |> dplyr::select(year=Year,lag2_Spr_NPGO = Spr_NPGO, lag2_Spr_PDO = Spr_PDO, lag2_Sum_NPGO = Sum_NPGO, lag2_Sum_PDO = Sum_PDO)



# #fish data combined with river and ocean covariates for modeling
# fish_river_ocean<-cnts_for_mod_fun(counts_through,Bon_cnts) |>
#   dplyr::left_join(flow_temp_dat |>
#                      dplyr::filter(month==forecast_month,
#                                    md==forecast_md) |>
#                      dplyr::select(year=Year,cfs_mean_ema,temp_mean_ema),
#   ) |>
#   dplyr::left_join(
#     ocean_cov
#   )|>
#         dplyr::mutate(
#           cnt_by_flow= cfs_mean_ema*log_cum_cnt,
#           cnt_by_temp= temp_mean_ema *log_cum_cnt,
#         )
# 
# 
# old_sib_R<-do_sibregresr_fun(fish_river_ocean,cov_vec=c("log_cum_cnt","cfs_mean_ema","cnt_by_temp"))
# 
# 
# new_sib_R<-do_sibregresr_fun(fish_river_ocean,cov_vec=c("log_cum_cnt","cfs_mean_ema","cnt_by_temp"))
# 
# 
# new_arima<-do_salmonForecasting_fun(data=fish_river_ocean,cov_vec=c("log_cum_cnt","cnt_by_flow"))
# 
# old_arima<-do_salmonForecasting_fun(data=fish_river_ocean,cov_vec=c("log_cum_cnt","cfs_mean_ema"=))
```



```{r  number_crunching}

Bon_ch<-Bon_ch_fun(forecastdate,Bon_cnts)

Bon_ch_year<-Bon_ch |> dplyr::filter(year==forecast_year)|>
  dplyr::filter(month>=4)
Bon_ch_day<-Bon_ch_year |> dplyr::filter(CountDate==forecastdate)

highlight_row <- which(Bon_ch_year$CountDate == forecastdate)

```

The cumulative adult Chinook passage at Bonneville Dam through `r forecastdate  |>  format("%B %d, %Y")` is `r Bon_ch_day$total |> format(scientific=FALSE, big.mark=",")`.

<!-- The 5-year (`r paste0((forecast_year-5),"--",(forecast_year-1))` ) average proportion of the run that had passed Bonneville through `r counts_through |>  format("%B %d")` is `r round((Bon_ch_day$Ave_5yr)*100,1)`%. Based on the cumulative counts to date and this proportion, the expected run size is `r format(round(Bon_ch_day$pred_Ave_5yr),scientific=FALSE, big.mark=",")` fish. -->

The 10-year (`r paste0((forecast_year-10),"--",(forecast_year-1))` ) average proportion of the run that had passed Bonneville through `r forecastdate  |>  format("%B %d")` is `r round((Bon_ch_day$Ave_10yr)*100,1)`%. Based on the cumulative counts to date and this proportion, the expected total dam count is `r format(round(Bon_ch_day$pred_Ave_10yr),scientific=FALSE, big.mark=",")` adult Chinook.

## {.tabset}

### Current year

```{r plot_cnts_env, fig.cap="Daily adult chinook salmon counts, flow, and temeprature measurements taken at Bonneville Dam."}
flow_temp_dat  |> 
  dplyr::select(Date=flw_date ,`Flow (kcfs)`=cfs_USACoE , `River temp. (F)`=temp_f_ASACE) |> 
  dplyr::mutate(Date=as.Date(Date),`Flow (kcfs)`=`Flow (kcfs)`/1000) |> 
  dplyr::inner_join(
    bon_yr_seas |> 
      dplyr::select(Date=CountDate,`Adult count`=AdultChinook)
  ) |> 
  tidyr::pivot_longer(cols=c(`Adult count`, `Flow (kcfs)`, `River temp. (F)`),names_to="Param",values_to="Value")  |> 
  ggplot2::ggplot(ggplot2::aes(x=Date,y=Value,col=Param,shape=Param))+ ggplot2::geom_point(size=2.5,show.legend=FALSE)+ggplot2::geom_line(show.legend=FALSE)+ggplot2::facet_wrap(~Param,ncol=1,scales="free_y")+
  ggplot2::scale_color_manual(values=c("#E69F00","#56B4E9","#CC79A7"))+
  ggplot2::labs(y="",
                col=NULL,
                shape=NULL)+
  ggplot2::theme(legend.key=ggplot2::element_blank())+ggplot2::theme_dark()+ggplot2::theme(axis.title.x = ggplot2::element_blank(),text = ggplot2::element_text(size=18))


```




### Percent complete

```{r timing_plot, fig.cap= "Percent of the run complete by date, 1995--2024."}
Bon_ch |> dplyr::filter(dplyr::between(year,forecast_year-15,forecast_year-1)) |> dplyr::mutate(date=(as.Date(paste(forecast_year,month,mday,sep="-")))) |>
  dplyr::filter(month>=4) |> 
  ggplot2::ggplot(ggplot2::aes(x=date,y=prop))+ggplot2::geom_boxplot(ggplot2::aes(group = date))+ ggplot2::scale_x_date(
    date_breaks = "1 month",
    date_labels = "%b"
  )+ggplot2::geom_vline(ggplot2::aes(xintercept = forecastdate),col="firebrick",lty=2,lwd=1)+ggplot2::ylab("Percent passage complete")+ ggplot2::scale_y_continuous(labels = scales::unit_format(suffix="%",scale = 100))+ggplot2::theme_dark()+ggplot2::theme(axis.title.x = ggplot2::element_blank(),text = ggplot2::element_text(size=18))

```

### Prediction error

```{r MAPE_10_year, fig.cap= "Mean absolute percent error  (over 15 year retrospectiv) of predictions based on cumulative counts and 10-year average run timing, by day of year."}
Bon_ch_year |>
  dplyr::filter(month>=4) |> ggplot2::ggplot(ggplot2::aes(y = (MAPE_10yr),x=CountDate))+ggplot2::geom_col(fill="white")+ggplot2::geom_vline(ggplot2::aes(xintercept = forecastdate),col="firebrick",lty=2,lwd=1)+ggplot2::ylab("Mean absolute percent error (MAPE)") + ggplot2::scale_y_continuous(labels = scales::unit_format(suffix="%",scale = 100))+ggplot2::theme_dark()+ggplot2::theme(axis.title.x = ggplot2::element_blank(),text = ggplot2::element_text(size=18))#+ ggplot2::geom_hline(ggplot2::aes(yintercept=30),lty=2)

```



## Model predictions {.tabset}

```{r modeling,include=FALSE}
model_results<-mod_results(forecastdate = forecastdate,
                           Count_dat = Bon_cnts,
                           River_dat = flow_temp_dat,
                           Ocean_dat = ocean_cov,
                           forecast = ifelse(forecast_season=="spring",122500,38000),
                           forecast_log_sd = ifelse(forecast_season=="spring",0.3,0.33))


# add 10 year timing to model resutls
model_results2<-model_results |> 
  dplyr::bind_rows(
    Bon_ch_year |> 
      dplyr::ungroup()|> dplyr::filter(dplyr::between(CountDate,                                            as.Date(paste0(forecast_year,"-04-05")),
                                               forecastdate)) |>
      dplyr::mutate(`Lo 95`=exp(qnorm(.025,log(pred_Ave_10yr),log_sd_10yr)),
                    `Lo 50`=exp(qnorm(.25,log(pred_Ave_10yr),log_sd_10yr)),
                    `Hi 50`=exp(qnorm(.75,log(pred_Ave_10yr),log_sd_10yr)),
                    `Hi 95`=exp(qnorm(.975,log(pred_Ave_10yr),log_sd_10yr)),
                    mod_type="10-year\nave. timing",
                    MAPE_10yr=MAPE_10yr*100) |>
      dplyr::select(mod_type,predicted_abundance=pred_Ave_10yr,`Lo 95`:`Hi 95`,MAPE=MAPE_10yr,date=CountDate)
  ) 
```


### Prediction table

```{r}
Pred_tab<-model_results2 |> dplyr::filter(date==forecastdate) |> dplyr::select(Model=mod_type,Pred =predicted_abundance,`Lo 95`:`Hi 95`,MAPE) |> 
dplyr::mutate(dplyr::across(dplyr::where(is.numeric),\(x)format(round(x),scientific=FALSE, big.mark=","))) |>  knitr::kable(format = "html") |>
  kableExtra::kable_styling(full_width = TRUE)

htmltools::browsable(
  Pred_tab #|>
    # kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) |> 
  # kableExtra::scroll_box(height = "400px", width = "100%")
)



```




### Prediction plot

```{r plot_pred_together}
# cb_palette <- c("#000000",
#                 "#E69F00",
#                 "#56B4E9",
#                 "#009E73")
# 
# cb_palette <- c("#88CCEE",
#                      "#CC6677",
#                      "#117733",
#                      "#AA4499")



model_results2<- model_results2 |>
  dplyr::mutate(across(c(`Hi 95`,`Hi 50`),\(x)ifelse(x>(2.5*predicted_abundance),NA,x)),
                across(c(`Lo 95`,`Lo 50`),\(x)ifelse(x<(.4*predicted_abundance),NA,x)))
cb_palette <- c("#F0E442",
                    "#56B4E9",
                  "#009E73",
                     "#CC79A7")


model_results2 |> ggplot2::ggplot(ggplot2::aes(x=date,y=predicted_abundance,color=mod_type))+ggplot2::geom_line()+ggplot2::geom_point(size=2.5)+ggplot2::ylab("Predicted total dam count")+ ggplot2::scale_y_continuous(labels = scales::unit_format(suffix="k",scale = 1e-3))+ggplot2::scale_color_manual(values = cb_palette) +ggplot2::theme_dark()+ggplot2::theme(axis.title.x = ggplot2::element_blank(),text = ggplot2::element_text(size=18),legend.position = "top",legend.title = ggplot2::element_blank())
```


### Prediction interval plot


```{r plot_pred_separate,fig.cap="Daily predictions and prediction intervals (95% and 50%).  Pridiction intervals that are >250% or <40% of the prediction are not shown." }

model_results2 |> ggplot2::ggplot(ggplot2::aes(x=date,y=predicted_abundance,color=mod_type))+ggplot2::geom_ribbon(ggplot2::aes(ymin=`Lo 95`,ymax=`Hi 95`),alpha=.5,color=NA)+ggplot2::geom_ribbon(ggplot2::aes(ymin=`Lo 50`,ymax=`Hi 50`),alpha=.5,color=NA)+ggplot2::geom_line()+ggplot2::geom_point(size=2.5)+ggplot2::facet_wrap(~mod_type)+ ggplot2::scale_y_continuous(labels = scales::unit_format(suffix="k",scale = 1e-3))+ ggplot2::scale_x_date(
    date_breaks = "5 days",
    date_labels = "%b %d"
  )+ggplot2::scale_color_manual(values = cb_palette) +ggplot2::theme_dark()+ggplot2::theme(axis.title.x = ggplot2::element_blank(),text = ggplot2::element_text(size=18),legend.position = "none")+ggplot2::ylab("Predicted total dam count")

```


### Methods description


##### DLM

This is a penalized dynamic linear model fit with the [`Sibregresr` package](https://wdfw-fp.github.io/sibregresr/articles/Overview.html). The coefficients are the:

1) log-transformed total count of jacks at Bonneville Dam in the *previous* year, 
2) log-transformed cumulative adult count at Bonneville Dam in the *current* year,
3) and interaction between an exponential moving average of river discharge and the cumulative adult count.

The prediction interval is based on the standard deviation (in lo-space) of forecasts from a 15-year retrospective. In other words, the root mean square error of the forecast error in log space from a 15-year retrospective is used as the standard deviation in a lognormal prediction interval.

#### ARIMA

This is an ensemble of ARIMA models  fit with the [`SalmonForecasting` package](https://github.com/wdfw-fp/salmonforecast) (see README at the linked page for details). The covariates are the same as those described above for the DLM, and the prediction intervals are calculated in the same manner as well.

#### Joint likelihood

This is a version of a model that has been used for this purpose of in-season forecasting for several years. The proportion of the run that is complete on a given day is modeled with autoregressive (order 1) errors and an effect of the river discharge covariate. In this iteration, the pre-season forecast is fed in as a log-normal prior. The prediction interval is generated using the delta method. I have not yet implemented a retrospective assesment of performance because, in this version, the pre-season forecasts and prediction uncertainty need to be provided, and I have not pulled in the past 15 years' foreacts.

#### 10 year average run timing

This method takes the 10-year average of the proporiton of the run that was complete on a given day and uses it to expand the cumulative counts to date. Performance and prediction intervals are based on a `5-year retrospective as described above for the DLM. 


## Average timing info {.tabset}


### 10-year average

#### Prediction
```{r}

pred10yr_tab<-Bon_ch_year|> dplyr::filter(dplyr::between(CountDate,                                            as.Date(paste0(forecast_year,"-04-01")),
                                               forecastdate)) |> dplyr::ungroup()|>  dplyr::mutate(Date=format(CountDate,"%d-%b")) |> 
  
  dplyr::select(Date,pred_Ave_10yr_10_days_early:pred_Ave_10yr_1_days_early,pred_Ave_10yr,pred_Ave_10yr_1_days_late:pred_Ave_10yr_10_days_late) |> 
  `colnames<-`(c("Date",paste(10:1,"Days Early"),"10yr Average",paste(1:10,"Days Late"))) |> 
  dplyr::mutate(dplyr::across(dplyr::where(is.numeric),\(x)format(round(x),scientific=FALSE, big.mark=","))) |>  knitr::kable(format = "html") |>
  kableExtra::kable_styling(full_width = TRUE) |>
  kableExtra::column_spec(12, background = "lightgrey")|>
  kableExtra::row_spec(highlight_row, background = "lightgrey")

htmltools::browsable(
  pred10yr_tab |>
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) |> 
  kableExtra::scroll_box(height = "400px", width = "100%")
)

```



#### Proportion complete

```{r}
prop10yr_tab<-Bon_ch_year |> dplyr::filter(dplyr::between(CountDate,                                            as.Date(paste0(forecast_year,"-04-01")),
                                               forecastdate))|> dplyr::ungroup()|>  dplyr::mutate(Date=format(CountDate,"%d-%b")) |> 
  
  dplyr::select(Date,Ave_10yr_10_days_early:Ave_10yr_1_days_early,Ave_10yr,Ave_10yr_1_days_late:Ave_10yr_10_days_late) |> 
  `colnames<-`(c("Date",paste(10:1,"Days Early"),"10yr Average",paste(1:10,"Days Late"))) |> 
  dplyr::mutate(dplyr::across(dplyr::where(is.numeric),\(x)round(x,2))) |>  knitr::kable(format = "html") |>
  kableExtra::kable_styling(full_width = TRUE) |>
  kableExtra::column_spec(12, background = "lightgrey")|>
  kableExtra::row_spec(highlight_row, background = "lightgrey")

htmltools::browsable(
  prop10yr_tab |>
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) |> 
  kableExtra::scroll_box(height = "400px", width = "100%")
)
```





### 5-year average

#### Prediction

```{r}
pred5yr_tab<-Bon_ch_year|> dplyr::filter(dplyr::between(CountDate,                                            as.Date(paste0(forecast_year,"-04-01")),
                                               forecastdate)) |> dplyr::ungroup()|>  dplyr::mutate(Date=format(CountDate,"%d-%b")) |> 
  
  dplyr::select(Date,pred_Ave_5yr_10_days_early:pred_Ave_5yr_1_days_early,pred_Ave_5yr,pred_Ave_5yr_1_days_late:pred_Ave_5yr_10_days_late) |> 
  `colnames<-`(c("Date",paste(10:1,"Days Early"),"5yr Average",paste(1:10,"Days Late"))) |> 
  dplyr::mutate(dplyr::across(dplyr::where(is.numeric),\(x)format(round(x),scientific=FALSE, big.mark=","))) |>  knitr::kable(format = "html") |>
  kableExtra::kable_styling(full_width = TRUE) |>
  kableExtra::column_spec(12, background = "lightgrey")|>
  kableExtra::row_spec(highlight_row, background = "lightgrey")

htmltools::browsable(
  pred5yr_tab |>
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) |> 
  kableExtra::scroll_box(height = "400px", width = "100%")
)
```


#### Proportion complete

```{r}
prop5yr_tab<-Bon_ch_year |> dplyr::filter(dplyr::between(CountDate,                                            as.Date(paste0(forecast_year,"-04-01")),
                                               forecastdate))|> dplyr::ungroup()|>  dplyr::mutate(Date=format(CountDate,"%d-%b")) |> 
  
  dplyr::select(Date,Ave_5yr_10_days_early:Ave_5yr_1_days_early,Ave_5yr,Ave_5yr_1_days_late:Ave_5yr_10_days_late) |> 
  `colnames<-`(c("Date",paste(10:1,"Days Early"),"5yr Average",paste(1:10,"Days Late"))) |> 
  dplyr::mutate(dplyr::across(dplyr::where(is.numeric),\(x)round(x,2))) |>  knitr::kable(format = "html") |>
  kableExtra::kable_styling(full_width = TRUE) |>
  kableExtra::column_spec(12, background = "lightgrey")|>
  kableExtra::row_spec(highlight_row, background = "lightgrey")

htmltools::browsable(
  prop5yr_tab |>
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) |> 
  kableExtra::scroll_box(height = "400px", width = "100%")
)
```


\linebreak



